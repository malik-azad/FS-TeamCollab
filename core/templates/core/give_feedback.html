<!-- core/templates/core/give_feedback.html -->
{% extends "core/base.html" %}
{% load static %}

{% block title %}Give Feedback - KU Feedback System{% endblock title %}

{% block extra_css %}
<style>
    /* Styles from previous iteration */
    .rating-questions-container .question-item { margin-bottom: 1.5rem; padding: 1rem; background-color: #f9fafb; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
    .rating-questions-container .question-text { display: block; margin-bottom: 0.75rem; font-weight: 500; color: #374151; }
    .rating-questions-container .rating-options { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .rating-questions-container .rating-options label {
        display: flex; align-items: center; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; 
        border-radius: 0.375rem; cursor: pointer; transition: all 0.2s ease-in-out; 
        font-size: 0.875rem; min-width: 90px; text-align: center;
    }
    .rating-questions-container .rating-options input[type="radio"] {
        opacity: 0; width: 0; height: 0; position: absolute; 
    }
    .rating-questions-container .rating-options input[type="radio"]:checked + span.rating-label-text { 
        background-color: var(--color-custom-blue, #0ea5e9); color: white; 
        border-color: var(--color-custom-blue, #0ea5e9); font-weight: 600;
    }
    .rating-questions-container .rating-options label:hover span.rating-label-text { 
        border-color: var(--color-custom-blue-dark, #0284c7); background-color: #eff6ff;
    }
    .rating-questions-container span.rating-label-text {
        padding: 0.375rem 0.625rem; border-radius: 0.25rem; 
        border: 1px solid transparent; display: block; width: 100%;
    }

    .input-method-toggle label { cursor: pointer; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
    .input-method-toggle input[type="radio"]:checked + label { background-color: var(--color-custom-blue, #0ea5e9); color: white; border-color: var(--color-custom-blue, #0ea5e9); }
    .input-method-toggle input[type="radio"] { display: none; }
</style>
{% endblock extra_css %}

{% block content %}
<div class="py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-xl">
        <h1 class="text-2xl sm:text-3xl font-bold text-custom-gray-dark mb-6 text-center">
            Submit Your Valuable Feedback
        </h1>

        <form method="POST" enctype="multipart/form-data" id="giveFeedbackForm" novalidate>
            {% csrf_token %}

            <!-- Verbose Form Error Display -->
            {% if form.non_field_errors %}
                <div class="p-4 mb-6 text-sm text-red-700 bg-red-100 rounded-lg border border-red-300" role="alert">
                    <p class="font-bold">Please correct the following general errors:</p>
                    <ul class="mt-2 list-disc list-inside">
                        {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                </div>
            {% endif %}
            {% for field in form.visible_fields %}
                {% if field.errors %}
                    <div class="p-2 mb-2 text-sm text-red-700 bg-red-50 rounded-lg border border-red-200" role="alert">
                        <strong class="capitalize">{{ field.label_tag|striptags|capfirst|default:field.name|capfirst }}:</strong>
                        <ul class="list-disc list-inside ml-4">
                        {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    </div>
                {% endif %}
            {% endfor %}
            
            <!-- Category Selection -->
            <div class="mb-6">
                <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-custom-gray-dark mb-1">{{ form.category.label }}</label>
                {{ form.category }}
            </div>
            
            <!-- Input Method Selection -->
            <div class="mb-6">
                <span class="block text-sm font-medium text-custom-gray-dark mb-2">{{ form.input_method.label_tag }}</span>
                <div class="flex space-x-4 input-method-toggle">
                    {% for radio in form.input_method %}
                    <div class="flex items-center">
                        {{ radio.tag }} 
                        <label for="{{ radio.id_for_label }}" class="ml-1">{{ radio.choice_label }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Text Feedback Area -->
            <div id="text-feedback-container" class="mb-6">
                <label for="{{ form.text_feedback.id_for_label }}" class="block text-sm font-medium text-custom-gray-dark mb-1">{{ form.text_feedback.label }}</label>
                {{ form.text_feedback }}
            </div>

            <!-- Audio Feedback Section - SIMPLIFIED to file input only -->
            <div id="audio-feedback-container" class="mb-6 hidden">
                <label for="{{ form.audio_feedback.id_for_label }}" class="block text-sm font-medium text-custom-gray-dark mb-1">Upload Audio Feedback File</label>
                {{ form.audio_feedback }} {# This is the Django file input field #}
                <p class="mt-1 text-xs text-gray-500">Upload an audio file (e.g., .mp3, .wav). Max 10MB.</p>
            </div>

            <!-- Rating Questions Container -->
            <div id="rating-questions-container" class="mb-6 rating-questions-container">
                <!-- JS will populate this section -->
            </div>
            
            <!-- Hidden Original Django Form Fields for Ratings -->
            <div class="hidden"> 
                {{ form.rating1 }} {{ form.rating2 }} {{ form.rating3 }}
                {{ form.rating4 }} {{ form.rating5 }}
            </div>
          
            <!-- Anonymous Checkbox -->
            <div class="mb-8">
                <div class="flex items-center">
                    {{ form.is_anonymous }}
                    <label for="{{ form.is_anonymous.id_for_label }}" class="ml-2 block text-sm text-custom-gray-dark">stay anonymous</label>
                </div>
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-semibold text-white bg-custom-blue hover:bg-custom-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-blue-dark transition duration-150 ease-in-out">
                    Submit Feedback
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Django's json_script template tag to safely pass data to JavaScript -->
{{ available_categories_data|json_script:"available-categories-data" }}
{{ rating_labels_data|json_script:"rating-labels-data" }}

<script>
    let availableCategories = []; // Initialize as empty array
    let ratingLabels = {};      // Initialize as empty object

    try {
        const categoriesElement = document.getElementById('available-categories-data');
        if (categoriesElement && categoriesElement.textContent) {
            availableCategories = JSON.parse(categoriesElement.textContent);
        } else {
            console.error("JS: available-categories-data script tag or its content not found.");
        }
        
        const ratingsElement = document.getElementById('rating-labels-data');
        if (ratingsElement && ratingsElement.textContent) {
            ratingLabels = JSON.parse(ratingsElement.textContent);
        } else {
            console.error("JS: rating-labels-data script tag or its content not found.");
        }
    } catch (e) {
        console.error("Error parsing JSON data from Django script tags:", e);
        // Provide minimal fallbacks if parsing fails
        ratingLabels = {1: '1', 2: '2', 3: '3', 4: '4', 5: '5'}; 
    }

    console.log("Parsed Available Categories:", availableCategories);
    console.log("Parsed Rating Labels:", ratingLabels);

    const HARDCODED_CATEGORY_QUESTIONS = {
        'TEACHING': [ "Clarity of explanations?", "Instructor engagement?", "Course content relevance?", "Fairness of grading?", "Overall teaching effectiveness?" ],
        'INFRASTRUCTURE': [ "Classroom/lab conditions?", "IT resources (Wi-Fi, PCs)?", "Library resources/space?", "Sports facilities?", "Overall campus infrastructure?" ],
        'TRANSPORT': [ "Transport punctuality?", "Bus comfort & safety?", "Route accessibility?", "Transport staff behavior?", "Overall transport satisfaction?" ],
        'EXTRACURRICULAR': [ "Variety/quality of activities?", "Support for student clubs?", "Sports/cultural event opportunities?", "Communication about activities?", "Overall extracurricular satisfaction?" ],
        'STAFF_BEHAVIOUR': [ "Administrative staff professionalism?", "Support staff helpfulness?", "Faculty accessibility (non-academic)?", "Fairness in staff dealings?", "Overall experience with staff?" ],
        'CANTEEN': [ "Food quality/taste?", "Variety of food options?", "Canteen hygiene?", "Value for money?", "Overall canteen satisfaction?" ],
        'LIBRARY': [ "Book/journal availability?", "Library staff helpfulness?", "Study environment comfort?", "Digital resource access?", "Overall library effectiveness?" ]
    };
    console.log("Hardcoded Category Questions Map:", HARDCODED_CATEGORY_QUESTIONS);

    const initialFormValues = {
        category: '{{ form.category.value|default_if_none:""|escapejs }}',
        input_method: '{{ form.input_method.value|default_if_none:"TEXT"|escapejs }}',
        rating1: '{{ form.rating1.value|default_if_none:""|escapejs }}',
        rating2: '{{ form.rating2.value|default_if_none:""|escapejs }}',
        rating3: '{{ form.rating3.value|default_if_none:""|escapejs }}',
        rating4: '{{ form.rating4.value|default_if_none:""|escapejs }}',
        rating5: '{{ form.rating5.value|default_if_none:""|escapejs }}'
    };
    console.log("Initial Form Values for JS:", initialFormValues);


    document.addEventListener('DOMContentLoaded', function() {
        const categorySelect = document.getElementById('{{ form.category.id_for_label }}');
        const ratingQuestionsContainer = document.getElementById('rating-questions-container');
        const inputMethodRadios = document.querySelectorAll('input[name="{{ form.input_method.html_name }}"]');
        const textFeedbackContainer = document.getElementById('text-feedback-container');
        const audioFeedbackContainer = document.getElementById('audio-feedback-container');
        // Removed audio button variables, only need audioFeedbackContainer

        console.log("DOM Elements: categorySelect=", categorySelect, "ratingQuestionsContainer=", ratingQuestionsContainer);

        function updateRatingQuestions(selectedCategoryValueKey) {
            console.log("JS: Updating rating questions for category value_key:", selectedCategoryValueKey);
            if (!ratingQuestionsContainer) { console.error("JS: ratingQuestionsContainer not found!"); return; }
            ratingQuestionsContainer.innerHTML = ''; 
            
            if (!selectedCategoryValueKey || !HARDCODED_CATEGORY_QUESTIONS || !HARDCODED_CATEGORY_QUESTIONS[selectedCategoryValueKey]) {
                console.warn("JS: No hardcoded questions found for key:", selectedCategoryValueKey, "or HARDCODED_CATEGORY_QUESTIONS is not defined.");
                return;
            }

            const questions = HARDCODED_CATEGORY_QUESTIONS[selectedCategoryValueKey];
            console.log("JS: Questions for this category:", questions);

            if (questions && questions.length > 0) {
                questions.forEach((questionText, index) => {
                    const questionIndex = index + 1;
                    const fieldName = `rating${questionIndex}`;

                    const questionItemDiv = document.createElement('div');
                    questionItemDiv.className = 'question-item';
                    const questionLabel = document.createElement('span');
                    questionLabel.className = 'question-text';
                    questionLabel.textContent = `${questionIndex}. ${questionText}`;
                    questionItemDiv.appendChild(questionLabel);

                    const ratingOptionsDiv = document.createElement('div');
                    ratingOptionsDiv.className = 'rating-options';

                    if (ratingLabels && typeof ratingLabels === 'object' && Object.keys(ratingLabels).length > 0) {
                        const sortedRatingValues = Object.keys(ratingLabels).sort((a, b) => parseInt(a) - parseInt(b));
                        
                        for (const valueKey of sortedRatingValues) {
                            const desc = ratingLabels[valueKey];
                            const ratingLabelEl = document.createElement('label');
                            const radioInput = document.createElement('input');
                            radioInput.type = 'radio';
                            radioInput.name = fieldName; 
                            radioInput.value = valueKey; 
                            
                            if (initialFormValues[fieldName] && initialFormValues[fieldName] === valueKey) {
                                radioInput.checked = true;
                            }
                            
                            const ratingDescSpan = document.createElement('span');
                            ratingDescSpan.className = 'rating-label-text'; 
                            ratingDescSpan.textContent = desc; 
                            
                            ratingLabelEl.appendChild(radioInput);
                            ratingLabelEl.appendChild(ratingDescSpan);
                            ratingOptionsDiv.appendChild(ratingLabelEl);
                        }
                    } else {
                        console.error("JS: ratingLabels is not a valid object or is empty:", ratingLabels);
                        // Fallback to simple numeric labels if descriptive ones are missing
                        for (let i = 1; i <= 5; i++) { /* ... create basic numeric radios ... */ }
                    }
                    questionItemDiv.appendChild(ratingOptionsDiv);
                    ratingQuestionsContainer.appendChild(questionItemDiv);
                });
            }
        }
        
        function toggleFeedbackInputFields() {
            const checkedRadio = document.querySelector('input[name="{{ form.input_method.html_name }}"]:checked');
            if (!textFeedbackContainer || !audioFeedbackContainer) {
                console.error("JS: Text or Audio feedback container not found."); return;
            }
            const selectedMethod = checkedRadio ? checkedRadio.value : initialFormValues.input_method; // Fallback
            console.log("JS: Toggling input fields. Selected method:", selectedMethod);

            if (selectedMethod === 'TEXT') {
                textFeedbackContainer.classList.remove('hidden');
                audioFeedbackContainer.classList.add('hidden');
                const audioInputEl = document.getElementById('{{ form.audio_feedback.id_for_label }}');
                if (audioInputEl) audioInputEl.value = '';
            } else if (selectedMethod === 'AUDIO') {
                textFeedbackContainer.classList.add('hidden');
                audioFeedbackContainer.classList.remove('hidden');
                const textInputEl = document.getElementById('{{ form.text_feedback.id_for_label }}');
                if (textInputEl) textInputEl.value = ''; 
            }
        }

        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                const selectedCategoryId = this.value; // PK of FeedbackCategory
                // Find the category object in availableCategories to get its 'value_key' (e.g., 'TEACHING')
                if (!Array.isArray(availableCategories)) {
                    console.error("JS: availableCategories is not an array!", availableCategories);
                    updateRatingQuestions(null); // Clear questions if data is bad
                    return;
                }
                const selectedCategoryObject = availableCategories.find(cat => cat.id === selectedCategoryId);
                if (selectedCategoryObject) {
                    console.log("JS: Category changed. Selected object:", selectedCategoryObject);
                    updateRatingQuestions(selectedCategoryObject.value_key);
                } else {
                    console.warn("JS: Category changed, but no matching category object found for ID:", selectedCategoryId);
                    updateRatingQuestions(null); 
                }
            });
        } else {
            console.error("JS Error: Category select dropdown not found!");
        }

        if (inputMethodRadios.length > 0) {
            inputMethodRadios.forEach(radio => {
                radio.addEventListener('change', toggleFeedbackInputFields);
            });
        } else {
            console.error("JS Error: Input method radio buttons not found!");
        }
        
        // --- Initial setup on page load ---
        console.log("JS: Performing initial setup...");
        if (categorySelect && initialFormValues.category) {
            categorySelect.value = initialFormValues.category;
            console.log("JS: Initial category dropdown value set to:", initialFormValues.category);
        }
        
        const initialInputMethod = initialFormValues.input_method || 'TEXT';
        const targetRadio = document.querySelector(`input[name="{{ form.input_method.html_name }}"][value="${initialInputMethod}"]`);
        if (targetRadio) {
            targetRadio.checked = true;
            console.log("JS: Initial input method radio set to:", initialInputMethod);
        } else if (inputMethodRadios.length > 0) {
            inputMethodRadios[0].checked = true; 
            console.warn("JS: Initial input method value from form not found, defaulting to first radio.");
        }

        if (categorySelect && categorySelect.value) {
            if (!Array.isArray(availableCategories)) {
                 console.error("JS: availableCategories is not an array during initial setup! Cannot load questions.");
                 updateRatingQuestions(null);
            } else {
                const initialSelectedCategoryObject = availableCategories.find(cat => cat.id === categorySelect.value);
                if (initialSelectedCategoryObject) {
                    console.log("JS: Triggering initial updateRatingQuestions for value_key:", initialSelectedCategoryObject.value_key);
                    updateRatingQuestions(initialSelectedCategoryObject.value_key);
                } else {
                    console.log("JS: No initial category object found, clearing questions.");
                    updateRatingQuestions(null);
                }
            }
        } else {
            console.log("JS: No initial category selected, clearing questions.");
            updateRatingQuestions(null);
        }
        
        console.log("JS: Triggering initial toggleFeedbackInputFields.");
        toggleFeedbackInputFields();
        console.log("JS: Initial setup complete.");
    });
</script>
{% endblock content %}