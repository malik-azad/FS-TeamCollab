<!-- core/templates/core/view_department_feedback.html -->
{% extends "core/dashboard_base.html" %}
{% load static %}

{% block title %}View Feedback - {{ department_name }}{% endblock title %}

{% block dashboard_content %}
    <!-- Main Header -->
    <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-custom-gray-dark">Department Feedback</h1>
        <p class="mt-1 text-lg text-custom-gray">Review and filter all feedback submissions for the <span class="font-semibold text-custom-blue">{{ department_name }}</span> department.</p>
    </div>

    <!-- Feedback List Card -->
    <div class="bg-white shadow-xl rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <h3 class="text-lg font-semibold text-custom-gray-dark mb-4 md:mb-0">All Submissions</h3>
                
                <!-- FILTER FORM -->
                <form method="GET" action="{% url 'core:view_department_feedback' %}" class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
                    <!-- Dropdowns, Filter button, and Reset link as before -->
                    <select name="time_filter" class="w-full sm:w-48 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-custom-blue focus:border-custom-blue block p-2.5 cursor-pointer transition ease-in-out duration-150">
                        <option value="">All Time</option>
                        <option value="week" {% if current_time_filter == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if current_time_filter == 'month' %}selected{% endif %}>This Month</option>
                    </select>
                    <select name="category_filter" class="w-full sm:w-56 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-custom-blue focus:border-custom-blue block p-2.5 cursor-pointer transition ease-in-out duration-150">
                        <option value="">All Categories</option>
                        {% for category in all_categories %}
                            <option value="{{ category.id }}" {% if current_category_filter == category.id|stringformat:"s" %}selected{% endif %}>{{ category.get_name_display }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="w-full sm:w-auto text-white bg-custom-blue hover:bg-custom-blue-dark font-medium rounded-lg text-sm px-5 py-2.5 text-center transition">Filter</button>
                    <a href="{% url 'core:view_department_feedback' %}" class="text-sm font-medium text-gray-600 hover:text-custom-blue" title="Clear all filters">Reset</a>
                </form>
            </div>

            <!-- Summarize Button -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button id="summarizeBtn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                    Summarize these {{ department_feedback_list|length }} Results with AI
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
               
                <thead class="bg-gray-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Anonymous</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for fb in department_feedback_list %}
                    <tr class="feedback-row" data-feedback-id="{{ fb.id }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ fb.timestamp|date:"M d, Y, P" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{% if fb.is_anonymous and not fb.anonymity_revoked %}<span class="italic text-gray-500">Anonymous</span>{% else %}{{ fb.student.username }}{% if fb.student.profile.full_name %} <span class="text-xs text-gray-500">({{ fb.student.profile.full_name }})</span>{% endif %}{% endif %}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ fb.category.get_name_display }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{% if fb.is_anonymous %}{% if fb.anonymity_revoked %}<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">No (Revealed)</span>{% else %}<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Yes</span>{% endif %}{% else %}<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">No</span>{% endif %}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><a href="{% url 'core:view_feedback_detail' fb.id %}" class="text-custom-blue hover:text-custom-blue-dark hover:underline">View Details</a></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">No feedback submissions found matching your criteria. <a href="{% url 'core:view_department_feedback' %}" class="text-custom-blue hover:underline font-medium">Clear filters</a>.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock dashboard_content %}

{% block page_specific_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const summarizeBtn = document.getElementById('summarizeBtn');
    const feedbackRows = document.querySelectorAll('.feedback-row');

    // Check if the global modal elements from the base template are available
    if (typeof showModal !== 'function' || !document.getElementById('modalBody')) {
        console.error("Modal functions or elements from dashboard_base.html not found!");
        if (summarizeBtn) summarizeBtn.style.display = 'none'; // Hide button if modal is broken
        return;
    }

    if (summarizeBtn) {
        // Disable button if there is no feedback to summarize
        if (feedbackRows.length === 0) {
            summarizeBtn.disabled = true;
            summarizeBtn.textContent = 'No Results to Summarize';
        }

        summarizeBtn.addEventListener('click', function() {
            // Use the global modalBody element
            const modalBody = document.getElementById('modalBody');

            // 1. Show modal in loading state
            modalBody.innerHTML = `
                <div class="flex items-center justify-center flex-col text-center">
                    <svg class="animate-spin h-8 w-8 text-custom-blue mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="font-semibold text-lg text-gray-700">Generating Summary...</p>
                    <p class="text-sm text-gray-500">Please wait, the AI is processing the feedback.</p>
                </div>
            `;
            showModal(); // Call global function

            // 2. Gather feedback IDs
            const feedbackIds = Array.from(feedbackRows).map(row => row.dataset.feedbackId);

            // 3. Make AJAX POST request
            fetch("{% url 'core:summarize_feedback' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ feedback_ids: feedbackIds })
            })
            .then(response => response.json())
            .then(data => {
                // 4. Display result in modal
                if (data.error) {
                    modalBody.innerHTML = `<p class="text-red-600 font-semibold">Error:</p><p>${data.error}</p>`;
                } else {
                    let formattedSummary = data.summary
                        .replace(/\n/g, '<br>')
                        .replace(/\* /g, '</li><li>');
                    if (formattedSummary.startsWith('</li>')) {
                        formattedSummary = `<ul>${formattedSummary}</ul>`.replace('<ul></li>', '<ul>');
                    }
                    modalBody.innerHTML = `<div class="prose max-w-none summary-text" style="max-height:70vh; overflow-y:auto; padding:1rem;">${formattedSummary}</div>`;
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                modalBody.innerHTML = `<p class="text-red-600 font-semibold">A network error occurred.</p><p>Please check your connection and try again.</p>`;
            });
        });
    }
});
</script>
{% endblock page_specific_scripts %}