<!-- core/templates/core/analytics.html -->
{% extends "core/dashboard_base.html" %}
{% load static %}

{% block title %}Analytics - {{ department_name }}{% endblock title %}

{% block dashboard_content %}
    <!-- Main Header -->
    <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-custom-gray-dark">
            Feedback Analytics
        </h1>
        <p class="mt-1 text-lg text-custom-gray">
            Visual summary of feedback for the <span class="font-semibold text-custom-blue">{{ department_name }}</span> department.
        </p>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Overall Sentiment Chart Card -->
        <div class="bg-white shadow-xl rounded-xl p-6">
            <h3 class="text-lg font-semibold text-custom-gray-dark mb-4">Overall Sentiment Distribution</h3>
            {% if pie_chart_data.data %}
                <div class="w-full max-w-sm mx-auto">
                    <canvas id="sentimentPieChart"></canvas>
                </div>
            {% else %}
                <div class="text-center py-10 text-gray-500">
                    <p>Not enough data to display overall sentiment chart.</p>
                </div>
            {% endif %}
        </div>

        <!-- Sentiment by Category Chart Card -->
        <div class="bg-white shadow-xl rounded-xl p-6">
            <h3 class="text-lg font-semibold text-custom-gray-dark mb-4">Sentiment by Category</h3>
            {% if bar_chart_data.labels %}
                <div>
                    <canvas id="sentimentBarChart"></canvas>
                </div>
            {% else %}
                 <div class="text-center py-10 text-gray-500">
                    <p>Not enough data to display sentiment by category.</p>
                </div>
            {% endif %}
        </div>
    </div>

    {# Placeholder for more charts or data tables #}

{% endblock dashboard_content %}


{% block page_specific_scripts %}
<!-- Include Chart.js library from a CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Django's json_script tags to safely pass data -->
{{ pie_chart_data|json_script:"pie-chart-data" }}
{{ bar_chart_data|json_script:"bar-chart-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Data Parsing ---
    let pieChartData, barChartData;
    try {
        pieChartData = JSON.parse(document.getElementById('pie-chart-data').textContent);
        barChartData = JSON.parse(document.getElementById('bar-chart-data').textContent);
        console.log("Pie Chart Data:", pieChartData);
        console.log("Bar Chart Data:", barChartData);
    } catch (e) {
        console.error("Error parsing chart data from Django:", e);
        return; // Stop if data is broken
    }
    
    // --- Pie Chart for Overall Sentiment ---
    const pieChartCtx = document.getElementById('sentimentPieChart');
    if (pieChartCtx && pieChartData.labels.length > 0) {
        new Chart(pieChartCtx, {
            type: 'doughnut', // 'pie' or 'doughnut'
            data: {
                labels: pieChartData.labels,
                datasets: [{
                    label: 'Feedback Count',
                    data: pieChartData.data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)', // Negative (Red)
                        'rgba(75, 192, 192, 0.7)', // Positive (Teal)
                        'rgba(201, 203, 207, 0.7)'  // Neutral (Gray)
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(201, 203, 207, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                        text: 'Overall Sentiment Distribution'
                    }
                }
            }
        });
    }

    // --- Bar Chart for Sentiment by Category ---
    const barChartCtx = document.getElementById('sentimentBarChart');
    if (barChartCtx && barChartData.labels.length > 0) {
        new Chart(barChartCtx, {
            type: 'bar',
            data: {
                labels: barChartData.labels,
                datasets: [
                    {
                        label: 'Positive Feedback',
                        data: barChartData.positive_data,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Negative Feedback',
                        data: barChartData.negative_data,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            // Ensure only whole numbers are shown on the y-axis
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                        text: 'Sentiment Breakdown by Category'
                    }
                }
            }
        });
    }
});
</script>
{% endblock page_specific_scripts %}