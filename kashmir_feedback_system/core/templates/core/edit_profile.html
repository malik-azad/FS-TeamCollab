<!--        messages.error(request, "Access denied to this dashboard.") 
        auth_logout(request) 
        return redirect('core:login')
    past_feedbacks = Feedback.objects.filter(student=request.user).select_related('category', 'department_at_submission').order_by('-timestamp')
    return render(request, 'core/student_dashboard.html', {'past_feedbacks': past_feedbacks})

@login_required(login_url='core:login')
def give_feedback_view(request):
    # ... (give_feedback_view code as established) ...
    if not hasattr(request.user, 'profile') or not request.user.profile.department:
        messages.error(request, "Your profile is incomplete (missing department). Please update your profile.")
        return redirect('core:student_dashboard') 
    if request.user.profile.role != 'STUDENT':
        messages.error(request, "Only students can submit feedback.")
        return redirect('core:student_dashboard')
    rating_labels_map = Feedback.RATING_DESCRIPTIVE_LABELS 
    available_categories_for_js = []
 core/templates/core/edit_profile.html -->
{% extends "core/base.html" %}
{% load static %}

{% block title %}Edit Profile - KU Feedback System{% endblock title %}

{% block content %}
<div class="min-h-full flex items-center justify-center py-10 px-4 sm:px-6 lg:px-8 bg-brand-bg">
    <div class="max-w-md w-full space-y-6 bg-white p-8 sm:p-10 rounded-xl shadow-xl">
        <div>
            <h2 class="text-center text-3xl font-bold text-custom-gray-dark">
                Edit Your Profile
            </h2>
            {% if profile.profile_photo %}
                <img src="{{ profile.profile_photo.url }}" alt="Current Profile Photo" class="mt-4 mx-auto h-24 w-24 rounded-full object-cover">
            {% else %}
                <div class="mt-4 mx-auto h-24 w-24 rounded-full bg-custom-gray-light flex items-center justify-center text-custom-gray-darker text-4xl font-semibold">
                    {{ user.username|slice:":1"|upper }}
                </div>
            {% endif %}
        </div>

        <!-- Verbose Form Error Display -->
        {% if form.non_field_errors %}
            <div class="p-4 mb-6 text-sm text-red-700 bg-red-100 rounded-lg border border-red-300" role="alert">
                <p class="font-bold">Please correct the following general errors:</p>
                <ul class="mt-2 list-disc list-inside    all_db_categories = FeedbackCategory.objects.all().order_by('name')
    for cat_obj in all_db_categories:
        available_categories_for_js.append({'id': str(cat_obj.id), 'value_key': cat_obj.name, 'display_name': cat_obj.get_name_display()})
    if request.method == 'POST':
        form = GiveFeedbackForm(request.POST, request.FILES, user=request.user) 
        if form.is_valid():
            feedback = form.save(commit=False)
            feedback.student = request.user
            feedback.department_at_submission = request.user.profile.department
            if feedback.input_method == 'AUDIO' and feedback.audio_feedback: pass
            feedback.save()
            messages.success(request, "Thank you! Your feedback has been submitted successfully.")
            return redirect('core:student_dashboard')
        else:
            messages.error(request, "Please correct the errors highlighted below.")
    else:
        form = GiveFeedbackForm(user=request.user)
    context = {'form': form, 'available_categories_data': available_categories_for_js, 'rating_labels_data': rating_labels_map}
    return render(request, 'core/give_feedback.html', context)


@login_required(login_url='core:login')
def view_feedback_detail(request, feedback_id):
    # ... (view_feedback_detail code as established) ...
    feedback = get_object_or_404(Feedback, id=feedback_id)
    if feedback.student != request.user:
        messages.error(request, "You are not authorized to view this feedback.")
        return redirect('core:student_dashboard')
    category_value_key = feedback.category.name 
    rating_labels_map = Feedback.RATING_DESCRIPTIVE_LABELS
    context = {'feedback': feedback, 'category_value_key': category_value_key, 'rating_labels_data': rating_labels_map}
    return render(request, 'core/view_feedback_detail.html', context)

@login_required(login_url='core:login')
@require_POST 
def delete_feedback_view(request, feedback_id):
    # ... (delete_feedback_view code as established) ...
    feedback = get_object_or_404(Feedback, id=feedback_id)
    if feedback.student != request.user:
        messages.error(request, "You are not authorized to delete this feedback.")
        return redirect">
                    {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                </ul>
            </div>
        {% endif %}

        <form class="space-y-5" method="POST" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            
            {% for field in form.visible_fields %}
                <div class="field-wrapper">
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-custom-gray-dark mb-1">
                        {{ field.label }}
                    </label>
                    {{ field }}
                    {% if field.help_text %}
                        <p class="mt-1 text-xs text-custom-gray">{{ field.help_text }}</p>
                    {% endif %}
                    {% if field.errors %}
                        <div class="mt-1 text-xs text-red-500 font-medium">
                        {% for error in field.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
            
            {% for field in form.hidden_fields %}
                {{ field }}
            {% endfor %}


            <div class="pt-2">
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-semibold text-white bg-custom-blue hover:bg-custom-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-blue-dark transition duration-150 ease-in-out">
                    Save Changes
                </button>
            </div>
        </form>

        <p class="mt-6 text-center text-sm text-custom-gray">
            <a href="{% url 'core:student_dashboard' %}" class="font-medium text-custom-blue hover:text-custom-blue-dark hover:underline">
                Â« Back to Dashboard
            </a>
        </p>
    </div>
</div>
{% endblock content %}